@using JoinedTogetherGmtk2021.Game





<CastleGrid Floor="@CurrentFloor"
            Descended="@(coord=>OnDescended(coord))"
            Ascended="@(coord=>OnAscended(coord))"
			WinCondition="@TestWinCondition"
            WinConditionReached="@(()=>OnWinConditionReached())"
            ResetRequested="@OnReset" @ref="_grid"
            EnableBackpack="@EnableBackpack"/>

<p style="margin-top: 30px;font-style: italic;">Stuck? Press 'R' at any time to restart.</p>

@inject IJSRuntime JSRuntime
@code
{
    CastleGrid _grid;

	[Parameter]
	public Func<Floor> FloorFactory { get; set; }

	[Parameter]
	public EventCallback WinConditionReached { get; set; }

	[Parameter]
	public Func<CastleScenario, bool> WinCondition { get; set; }

    [Parameter]
    public bool EnableBackpack { get; set; }

    private Floor CurrentFloor { get; set; }

    private bool TestWinCondition()
    {
        return WinCondition(this);
    }

    protected override void OnParametersSet()
    {
        if (WinCondition == null)
            WinCondition = scenario =>
            {
                var playerPositions = CurrentFloor.GameObjects.Where(x => x.IsPlayer).Select(x => x.Position);
                var exitPositions = CurrentFloor.GameObjects.Where(x => x.IsExit).Select(x => x.Position);
                var winConditions = playerPositions.Intersect(exitPositions);
                return winConditions.Any();
            };

		StartGame();

        base.OnParametersSet();
    }

    private void StartGame()
    {
        var floorTemplate = FloorFactory();
        this.CurrentFloor = floorTemplate;
    }

    private void OnReset()
    {
        _grid.ClearBackpack();
        StartGame();

        StateHasChanged();
    }

    private async Task OnWinConditionReached()
    {
        await JSRuntime.InvokeAsync<string>("PlayWinSound");
        await WinConditionReached.InvokeAsync();
    }

    private async Task OnAscended(IReadOnlyCollection<FloorCoord> ascCoods)
    {
        await JSRuntime.InvokeAsync<string>("PlayLadderSound");

        var ladderPositions = CurrentFloor
            .Layout
            .Where(x => x.Value != null && x.Value.RoomType.HasLadderAsc)
            .Select(x => x.Key);

        Floor upperFloor;
        if (CurrentFloor.ParentFloor != null)
            upperFloor = CurrentFloor.ParentFloor;
        else
            upperFloor = FloorFactory();

        foreach (var ladderPosition in ladderPositions)
        {
            var currentRoomType = upperFloor.Layout[ladderPosition]?.RoomType;
            //if (!currentRoomType.Equals(RoomTypes.PATHN___))
            //{
                Console.WriteLine("adding ladder to "+ladderPosition);
                upperFloor.Layout[ladderPosition] = new Room(RoomTypes.PATHN___);
            //}
        }

        foreach (var ascCood in ascCoods)
        {
            var playerExistsAtPosition = upperFloor.GameObjects.Any(x => x.IsPlayer && x.Position.Equals(ascCood));
            if (!playerExistsAtPosition)
                upperFloor.GameObjects.Add(new GameObject{Position = ascCood,IsPlayer = true});
        }

		Console.WriteLine("ASSIGING CURRENT FLOOR");
        this.CurrentFloor = upperFloor;

        StateHasChanged();
    }

    private async Task OnDescended(IReadOnlyCollection<FloorCoord> descCoods)
    {
        await JSRuntime.InvokeAsync<string>("PlayLadderSound");

        var ladderPositions = CurrentFloor
            .Layout
            .Where(x => x.Value != null && x.Value.RoomType.HasLadderDesc)
            .Select(x => x.Key);

        var lowerFloor = FloorFactory();
		foreach (var ladderPosition in ladderPositions)
            lowerFloor.Layout[ladderPosition] = new Room(RoomTypes.PATH__S_);

        foreach (var descCood in descCoods)
        {
            var playerExistsAtPosition = lowerFloor.GameObjects.Any(x => x.IsPlayer && x.Position.Equals(descCood));
            if (!playerExistsAtPosition)
                lowerFloor.GameObjects.Add(new GameObject{Position = descCood,IsPlayer = true});
        }

        lowerFloor.ParentFloor = CurrentFloor;
        CurrentFloor = lowerFloor;
        StateHasChanged();
    }




}

